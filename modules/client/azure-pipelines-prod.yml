trigger:
  branches:
    include:
      - master
  paths:
    include:
      - "**/client/**"

pr:
  autoCancel: true
  branches:
    include:
      - master
  paths:
    include:
      - "**/client/**"

resources:
  - repo: self

# ---------------- Variables ----------------
variables:
  - group: "pina-colada-render-prod"
  - name: dockerRegistryServiceConnection
    value: "ghcr-conn"
  - name: owner
    value: "hubenschmidt"
  - name: imageName
    value: "pina-colada-client"
  - name: imageRepository
    value: "$(owner)/$(imageName)"
  - name: dockerfilePath
    value: "modules/client/Dockerfile.prod"
  - name: buildContext
    value: "modules/client"
  - name: tagLatest
    value: "latest"
  - name: tagBuildId
    value: "$(Build.SourceBranchName)-$(Build.BuildId)"

stages:
  - stage: Build
    displayName: Build app
    jobs:
      - job: Build
        displayName: Node build
        pool:
          name: Default # self-hosted Linux agent pool
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: "24"
            displayName: "Install Node.js"
          - task: Npm@1
            displayName: "npm install (modules/client)"
            inputs:
              command: "install"
              workingDir: "$(Build.SourcesDirectory)/modules/client"

  - stage: Push
    displayName: Push Docker Image to GHCR
    dependsOn: Build
    # Only deploy on master (avoid PR validations)
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - job: Push
        displayName: Build & push image
        pool:
          name: Default # self-hosted Linux agent pool
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: Docker@2
            displayName: "Build and push to GHCR"
            inputs:
              command: "buildAndPush"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)" # owner/name ONLY
              dockerfile: "$(dockerfilePath)"
              buildContext: "$(buildContext)"
              addPipelineData: false
              tags: |
                $(tagLatest)
                $(tagBuildId)

  - stage: DeployProd
    displayName: Deploy to Prod (Render)
    dependsOn: Push
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: Trigger Render Deploy (Prod)
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "Triggering deployment on Render (Prod)..."
              http_code=$(curl -sS -o /tmp/render_deploy.json -w "%{http_code}" -X POST "$RENDER_DEPLOY_HOOK_CLIENT_PROD")
              echo "POST deploy hook => $http_code"
              cat /tmp/render_deploy.json
              case "$http_code" in
                200|201|202) echo "Production deployment triggered." ;;
                *) echo "Production deployment failed"; exit 1 ;;
              esac
            displayName: "Trigger Render deploy (Prod)"
            env:
              RENDER_DEPLOY_HOOK_CLIENT_PROD: $(RENDER_DEPLOY_HOOK_CLIENT_PROD)
