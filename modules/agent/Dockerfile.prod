# syntax=docker/dockerfile:1.6

# Build stage
FROM golang:1.24-alpine AS builder
WORKDIR /app

ARG BUILD_ID=local
ENV BUILD_ID=${BUILD_ID}

RUN apk add --no-cache git ca-certificates

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s -X main.BuildID=${BUILD_ID}" -o /agent-go ./cmd/agent
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o /migrate ./cmd/migrate
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o /seed ./cmd/seed
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o /seed-documents ./cmd/seed-documents
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o /etl ./cmd/etl

# Runtime stage
FROM alpine:3.19

RUN apk add --no-cache ca-certificates tzdata bash

RUN adduser -D -g '' appuser

COPY --from=builder /agent-go /agent-go
COPY --from=builder /migrate /migrate
COPY --from=builder /seed /seed
COPY --from=builder /seed-documents /seed-documents
COPY --from=builder /etl /etl

COPY --from=builder /app/migrations /app/migrations
COPY --from=builder /app/seeders /app/seeders
COPY --from=builder /app/start-prod.sh /app/start-prod.sh

RUN chmod +x /app/start-prod.sh && chown -R appuser:appuser /app

USER appuser
WORKDIR /app

EXPOSE 8080

CMD ["./start-prod.sh"]
