trigger:
  branches:
    include:
      - master
  paths:
    include:
      - "**/agent/**"

pr:
  autoCancel: true
  branches:
    include:
      - master
  paths:
    include:
      - "**/agent/**"

resources:
  - repo: self

# ---------------- Variables ----------------
variables:
  - group: "pina-colada-digital-ocean"
  - name: dockerRegistryServiceConnection
    value: "ghcr-conn"
  - name: owner
    value: "hubenschmidt"
  - name: imageName
    value: "pina-colada-agent"
  - name: imageRepository
    value: "$(owner)/$(imageName)"
  - name: dockerfilePath
    value: "modules/agent/Dockerfile.prod"
  - name: buildContext
    value: "modules/agent"
  - name: tagLatest
    value: "latest"
  - name: tagBuildId
    value: "$(Build.SourceBranchName)-$(Build.BuildId)"

stages:
  - stage: Build
    displayName: Build agent
    jobs:
      - job: Build
        displayName: Docker build
        pool:
          name: Default # self-hosted Linux agent pool
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: Docker@2
            displayName: "Build Docker image"
            inputs:
              command: "build"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              dockerfile: "$(dockerfilePath)"
              buildContext: "$(buildContext)"
              tags: |
                $(tagLatest)
                $(tagBuildId)

  - stage: Migrate
    displayName: Run Database Migrations
    dependsOn: Build
    # Run migrations on all builds (including PRs) to validate schema changes
    jobs:
      - job: Migrate
        displayName: Apply Supabase Migrations
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "Installing Supabase CLI..."
              # Download and install Supabase CLI binary
              # Get latest version from GitHub releases
              SUPABASE_VERSION=$(curl -s https://api.github.com/repos/supabase/cli/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
              echo "Installing Supabase CLI version: $SUPABASE_VERSION"
              
              # Download binary for Linux x64
              curl -L "https://github.com/supabase/cli/releases/download/${SUPABASE_VERSION}/supabase_${SUPABASE_VERSION#v}_linux_amd64.tar.gz" -o /tmp/supabase.tar.gz
              
              # Extract and install to user-writable location
              mkdir -p $(Agent.ToolsDirectory)/supabase
              tar -xzf /tmp/supabase.tar.gz -C $(Agent.ToolsDirectory)/supabase
              chmod +x $(Agent.ToolsDirectory)/supabase/supabase
              
              # Add to PATH for this job
              echo "##vso[task.prependpath]$(Agent.ToolsDirectory)/supabase"
              
              # Verify installation
              supabase --version
            displayName: "Install Supabase CLI"
          
          - script: |
              echo "Initializing Supabase project structure..."
              # Initialize Supabase project (creates supabase/ directory)
              supabase init || true
              
              # Copy migrations to Supabase's expected location
              # Working directory is repo root, so supabase_migrations is at root level
              mkdir -p supabase/migrations
              if [ -d "supabase_migrations" ]; then
                cp -r supabase_migrations/*.sql supabase/migrations/ 2>/dev/null || echo "No migrations found"
                echo "✓ Copied migrations from supabase_migrations/"
              else
                echo "⚠️  supabase_migrations directory not found"
              fi
              
              echo "Linking to Supabase project..."
              echo "$SUPABASE_ACCESS_TOKEN" | supabase login --token-stdin
              supabase link --project-ref $(SUPABASE_PROJECT_REF)
            displayName: "Link Supabase Project"
            env:
              SUPABASE_ACCESS_TOKEN: $(SUPABASE_ACCESS_TOKEN)
            workingDirectory: $(System.DefaultWorkingDirectory)
          
          - script: |
              echo "Applying database migrations..."
              supabase db push
            displayName: "Push Migrations to Supabase"
            continueOnError: false
            workingDirectory: $(System.DefaultWorkingDirectory)

  - stage: Push
    displayName: Push Docker Image to GHCR
    dependsOn: Migrate
    # Only push on master (avoid PR validations)
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - job: Push
        displayName: Push image
        pool:
          name: Default # self-hosted Linux agent pool
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: Docker@2
            displayName: "Push to GHCR"
            inputs:
              command: "push"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              tags: |
                $(tagLatest)
                $(tagBuildId)

  - stage: Deploy
    displayName: Deploy to DigitalOcean App Platform
    dependsOn: Push
    # Only deploy on master (avoid PR validations)
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - job: Deploy
        displayName: Trigger DigitalOcean Deploy
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "Triggering deployment on DigitalOcean App Platform..."
              http_code=$(curl -sS -o /tmp/do_deploy.json -w "%{http_code}" \
                -X POST \
                -H "Authorization: Bearer $DO_API_TOKEN" \
                -H "Content-Type: application/json" \
                "https://api.digitalocean.com/v2/apps/$DO_APP_ID/deployments")
              echo "POST /deployments => $http_code"
              cat /tmp/do_deploy.json
              case "$http_code" in
                200|201|202) echo "Deployment triggered." ;;
                *) echo "Deployment API failed"; exit 1 ;;
              esac
            displayName: "Call DigitalOcean API to redeploy"
