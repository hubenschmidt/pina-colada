trigger:
  branches:
    include:
      - master
  paths:
    include:
      - "**/agent/**"

pr:
  autoCancel: true
  branches:
    include:
      - master
  paths:
    include:
      - "**/agent/**"

resources:
  - repo: self

# ---------------- Variables ----------------
variables:
  - group: "pina-colada-digital-ocean"
  - group: "pina-colada-supabase-prod"
  - name: dockerRegistryServiceConnection
    value: "ghcr-conn"
  - name: owner
    value: "hubenschmidt"
  - name: imageName
    value: "pina-colada-agent"
  - name: imageRepository
    value: "$(owner)/$(imageName)"
  - name: dockerfilePath
    value: "modules/agent/Dockerfile.prod"
  - name: buildContext
    value: "modules/agent"
  - name: tagLatest
    value: "latest"
  - name: tagBuildId
    value: "$(Build.SourceBranchName)-$(Build.BuildId)"

stages:
  - stage: Build
    displayName: Build agent
    jobs:
      - job: Build
        displayName: Docker build
        pool:
          name: Default # self-hosted Linux agent pool
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: Docker@2
            displayName: "Build Docker image"
            inputs:
              command: "build"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              dockerfile: "$(dockerfilePath)"
              buildContext: "$(buildContext)"
              tags: |
                $(tagLatest)
                $(tagBuildId)

  - stage: Migrate
    displayName: Run Database Migrations
    dependsOn: Build
    # Run migrations on all builds (including PRs) to validate schema changes
    jobs:
      - job: Migrate
        displayName: Apply Supabase Migrations
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "Installing Supabase CLI..."
              # Use official Supabase CLI installation method
              # This matches the approach used in supabase/setup-cli@v1 GitHub Action
              # For self-hosted agents, use a user-writable location
              SUPABASE_DIR=$(Agent.ToolsDirectory)/supabase
              mkdir -p $SUPABASE_DIR

              # Get version from latest release
              VERSION=$(curl -s https://api.github.com/repos/supabase/cli/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
              echo "Installing Supabase CLI version: $VERSION"

              # Download the binary - asset name is supabase_linux_amd64.tar.gz (not versioned in filename)
              curl -L "https://github.com/supabase/cli/releases/download/v${VERSION}/supabase_linux_amd64.tar.gz" -o /tmp/supabase.tar.gz

              # Verify download succeeded
              if [ ! -s /tmp/supabase.tar.gz ]; then
                echo "Error: Download failed or file is empty"
                exit 1
              fi

              # Extract
              tar -xzf /tmp/supabase.tar.gz -C $SUPABASE_DIR

              # Verify extraction succeeded
              if [ ! -f $SUPABASE_DIR/supabase ]; then
                echo "Error: Binary not found after extraction"
                ls -la $SUPABASE_DIR/
                exit 1
              fi

              # Make executable
              chmod +x $SUPABASE_DIR/supabase

              # Add to PATH for this job (works for both Microsoft-hosted and self-hosted agents)
              echo "##vso[task.prependpath]$SUPABASE_DIR"

              # Also export PATH in current shell for immediate use (self-hosted agent workaround)
              export PATH="$SUPABASE_DIR:$PATH"

              # Verify installation
              echo "Verifying installation..."
              $SUPABASE_DIR/supabase --version || supabase --version
            displayName: "Install Supabase CLI"

          - script: |
              echo "Initializing Supabase project structure..."
              # Ensure Supabase CLI is in PATH (for self-hosted agents)
              export PATH="$(Agent.ToolsDirectory)/supabase:$PATH"

              # Initialize Supabase project (creates supabase/ directory)
              # This matches the Supabase docs pattern: https://supabase.com/docs/guides/deployment/managing-environments
              supabase init || true

              # Copy migrations to Supabase's expected location (supabase/migrations/)
              # Migrations are located in modules/agent/migrations/
              mkdir -p supabase/migrations
              if [ -d "modules/agent/migrations" ]; then
                cp -r modules/agent/migrations/*.sql supabase/migrations/ 2>/dev/null || echo "No migrations found"
                echo "✓ Copied migrations from modules/agent/migrations/ to supabase/migrations/"
              else
                echo "⚠️  modules/agent/migrations directory not found"
                exit 1
              fi

              # Link to Supabase project (following Supabase docs pattern)
              # Requires SUPABASE_ACCESS_TOKEN and SUPABASE_PROJECT_ID environment variables
              echo "Linking to Supabase project..."

              # Verify environment variables are set (without exposing values)
              if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
                echo "Error: SUPABASE_ACCESS_TOKEN is not set"
                exit 1
              fi
              if [ -z "$SUPABASE_PROJECT_ID" ]; then
                echo "Error: SUPABASE_PROJECT_ID is not set"
                exit 1
              fi
              if [ -z "$SUPABASE_DB_PASSWORD" ]; then
                echo "Error: SUPABASE_DB_PASSWORD is not set"
                exit 1
              fi

              echo "Access token format: ${SUPABASE_ACCESS_TOKEN:0:10}... (length: ${#SUPABASE_ACCESS_TOKEN})"
              echo "Project ref format: ${SUPABASE_PROJECT_ID:0:10}... (length: ${#SUPABASE_PROJECT_ID})"

              supabase login --token "$SUPABASE_ACCESS_TOKEN"
              supabase link --project-ref "$SUPABASE_PROJECT_ID" --password "$SUPABASE_DB_PASSWORD"
            displayName: "Link Supabase Project"
            env:
              SUPABASE_ACCESS_TOKEN: $(SUPABASE_ACCESS_TOKEN)
              SUPABASE_PROJECT_ID: $(SUPABASE_PROJECT_ID)
              SUPABASE_DB_PASSWORD: $(SUPABASE_DB_PASSWORD)
            workingDirectory: $(System.DefaultWorkingDirectory)

          - script: |
              echo "Applying database migrations..."
              export PATH="$(Agent.ToolsDirectory)/supabase:$PATH"
              supabase db push --db-url "postgres://postgres.${SUPABASE_PROJECT_ID}:${SUPABASE_DB_PASSWORD}@aws-0-us-east-1.pooler.supabase.com:5432/postgres"
            displayName: "Push Migrations to Supabase"
            continueOnError: false
            workingDirectory: $(System.DefaultWorkingDirectory)
            env:
              SUPABASE_DB_PASSWORD: $(SUPABASE_DB_PASSWORD)
              SUPABASE_PROJECT_ID: $(SUPABASE_PROJECT_ID)

  - stage: Push
    displayName: Push Docker Image to GHCR
    dependsOn: Migrate
    # Only push on master (avoid PR validations)
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - job: Push
        displayName: Push image
        pool:
          name: Default # self-hosted Linux agent pool
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: Docker@2
            displayName: "Push to GHCR"
            inputs:
              command: "push"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              tags: |
                $(tagLatest)
                $(tagBuildId)

  - stage: Deploy
    displayName: Deploy to DigitalOcean App Platform
    dependsOn: Push
    # Only deploy on master (avoid PR validations)
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - job: Deploy
        displayName: Trigger DigitalOcean Deploy
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "Triggering deployment on DigitalOcean App Platform..."
              http_code=$(curl -sS -o /tmp/do_deploy.json -w "%{http_code}" \
                -X POST \
                -H "Authorization: Bearer $DO_API_TOKEN" \
                -H "Content-Type: application/json" \
                "https://api.digitalocean.com/v2/apps/$DO_APP_ID/deployments")
              echo "POST /deployments => $http_code"
              cat /tmp/do_deploy.json
              case "$http_code" in
                200|201|202) echo "Deployment triggered." ;;
                *) echo "Deployment API failed"; exit 1 ;;
              esac
            displayName: "Call DigitalOcean API to redeploy"
            env:
              DO_API_TOKEN: $(DO_API_TOKEN)
              DO_APP_ID: $(DO_APP_ID)
