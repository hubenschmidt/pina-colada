trigger:
  branches:
    include:
      - master
  paths:
    include:
      - "**/agent/**"

pr:
  autoCancel: true
  branches:
    include:
      - master
  paths:
    include:
      - "**/agent/**"

resources:
  - repo: self

# ---------------- Variables ----------------
variables:
  group: "pina-colada-digital-ocean"
  dockerRegistryServiceConnection: "ghcr-conn"
  owner: "hubenschmidt"
  imageName: "pina-colada-agent"
  imageRepository: "$(owner)/$(imageName)"
  dockerfilePath: "modules/agent/Dockerfile.prod"
  buildContext: "modules/agent"
  tagLatest: "latest"
  tagBuildId: "$(Build.SourceBranchName)-$(Build.BuildId)"
  doApiToken: $(DO_API_TOKEN)
  doAppId: $(DO_APP_ID)

stages:
  # - stage: Build
  #   displayName: Build agent
  #   jobs:
  #     - job: Build
  #       displayName: Docker build
  #       pool:
  #         name: Default # self-hosted Linux agent pool
  #         demands:
  #           - Agent.OS -equals Linux
  #       steps:
  #         - task: Docker@2
  #           displayName: "Build Docker image"
  #           inputs:
  #             command: "build"
  #             containerRegistry: "$(dockerRegistryServiceConnection)"
  #             repository: "$(imageRepository)"
  #             dockerfile: "$(dockerfilePath)"
  #             buildContext: "$(buildContext)"
  #             tags: |
  #               $(tagLatest)
  #               $(tagBuildId)

  # - stage: Push
  #   displayName: Push Docker Image to GHCR
  #   dependsOn: Build
  #   # Only deploy on master (avoid PR validations)
  #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  #   jobs:
  #     - job: Push
  #       displayName: Push image
  #       pool:
  #         name: Default # self-hosted Linux agent pool
  #         demands:
  #           - Agent.OS -equals Linux
  #       steps:
  #         - task: Docker@2
  #           displayName: "Push to GHCR"
  #           inputs:
  #             command: "push"
  #             containerRegistry: "$(dockerRegistryServiceConnection)"
  #             repository: "$(imageRepository)"
  #             tags: |
  #               $(tagLatest)
  #               $(tagBuildId)

  - stage: Deploy
    displayName: Deploy to DigitalOcean App Platform
    # dependsOn: Push
    # Only deploy on master (avoid PR validations)
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - job: Deploy
        displayName: Trigger DigitalOcean Deploy
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "=== Debugging Variables ==="
              echo "DO_API_TOKEN exists: $([[ -n '$(doApiToken)' ]] && echo 'YES' || echo 'NO')"
              echo "DO_APP_ID exists: $([[ -n '$(doAppId)' ]] && echo 'YES' || echo 'NO')"
              env | grep ^DO_ || echo "No DO_* variables found"
            displayName: "Debug - Check Variables"
          - script: |
              echo "Triggering deployment on DigitalOcean App Platform..."
              http_code=$(curl -sS -o /tmp/do_deploy.json -w "%{http_code}" \
                -X POST \
                -H "Authorization: Bearer $(DO_API_TOKEN)" \
                -H "Content-Type: application/json" \
                "https://api.digitalocean.com/v2/apps/$(DO_APP_ID)/deployments")
              echo "POST /deployments => $http_code"
              cat /tmp/do_deploy.json
              case "$http_code" in
                200|201|202) echo "Deployment triggered." ;;
                *) echo "Deployment API failed"; exit 1 ;;
              esac
            displayName: "Call DigitalOcean API to redeploy"
