trigger:
  branches:
    include:
      - develop
  paths:
    include:
      - "**/agent/**"

pr:
  autoCancel: true
  branches:
    include:
      - develop
  paths:
    include:
      - "**/agent/**"

resources:
  - repo: self

# ---------------- Variables ----------------
variables:
  - group: "pina-colada-digital-ocean"
  - group: "pina-colada-supabase-test"
  - name: dockerRegistryServiceConnection
    value: "ghcr-conn"
  - name: owner
    value: "hubenschmidt"
  - name: imageName
    value: "pina-colada-agent"
  - name: imageRepository
    value: "$(owner)/$(imageName)"
  - name: dockerfilePath
    value: "modules/agent/Dockerfile.prod"
  - name: buildContext
    value: "modules/agent"
  - name: tagTest
    value: "test"
  - name: tagBuildId
    value: "$(Build.SourceBranchName)-$(Build.BuildId)"

stages:
  - stage: Build
    displayName: Build agent
    jobs:
      - job: Build
        displayName: Docker build
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: Docker@2
            displayName: "Build Docker image"
            inputs:
              command: "build"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              dockerfile: "$(dockerfilePath)"
              buildContext: "$(buildContext)"
              tags: |
                $(tagTest)
                $(tagBuildId)

  - stage: Migrate
    displayName: Run Database Migrations
    dependsOn: Build
    jobs:
      - job: Migrate
        displayName: Apply Supabase Migrations
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "Installing Supabase CLI..."
              SUPABASE_DIR=$(Agent.ToolsDirectory)/supabase
              mkdir -p $SUPABASE_DIR

              VERSION=$(curl -s https://api.github.com/repos/supabase/cli/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
              echo "Installing Supabase CLI version: $VERSION"

              curl -L "https://github.com/supabase/cli/releases/download/v${VERSION}/supabase_linux_amd64.tar.gz" -o /tmp/supabase.tar.gz

              if [ ! -s /tmp/supabase.tar.gz ]; then
                echo "Error: Download failed or file is empty"
                exit 1
              fi

              tar -xzf /tmp/supabase.tar.gz -C $SUPABASE_DIR

              if [ ! -f $SUPABASE_DIR/supabase ]; then
                echo "Error: Binary not found after extraction"
                ls -la $SUPABASE_DIR/
                exit 1
              fi

              chmod +x $SUPABASE_DIR/supabase
              echo "##vso[task.prependpath]$SUPABASE_DIR"
              export PATH="$SUPABASE_DIR:$PATH"
              $SUPABASE_DIR/supabase --version || supabase --version
            displayName: "Install Supabase CLI"

          - script: |
              echo "Initializing Supabase project structure..."
              export PATH="$(Agent.ToolsDirectory)/supabase:$PATH"

              supabase init || true

              mkdir -p supabase/migrations
              if [ -d "modules/agent/migrations" ]; then
                cp -r modules/agent/migrations/*.sql supabase/migrations/ 2>/dev/null || echo "No migrations found"
                echo "✓ Copied migrations from modules/agent/migrations/ to supabase/migrations/"
              else
                echo "⚠️  modules/agent/migrations directory not found"
                exit 1
              fi

              echo "Linking to Supabase project..."

              if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
                echo "Error: SUPABASE_ACCESS_TOKEN is not set"
                exit 1
              fi
              if [ -z "$SUPABASE_PROJECT_ID" ]; then
                echo "Error: SUPABASE_PROJECT_ID is not set"
                exit 1
              fi
              if [ -z "$SUPABASE_DB_PASSWORD" ]; then
                echo "Error: SUPABASE_DB_PASSWORD is not set"
                exit 1
              fi

              echo "Access token format: ${SUPABASE_ACCESS_TOKEN:0:10}... (length: ${#SUPABASE_ACCESS_TOKEN})"
              echo "Project ref format: ${SUPABASE_PROJECT_ID:0:10}... (length: ${#SUPABASE_PROJECT_ID})"

              supabase login --token "$SUPABASE_ACCESS_TOKEN"
              supabase link --project-ref "$SUPABASE_PROJECT_ID" --password "$SUPABASE_DB_PASSWORD"
            displayName: "Link Supabase Project"
            env:
              SUPABASE_ACCESS_TOKEN: $(SUPABASE_ACCESS_TOKEN)
              SUPABASE_PROJECT_ID: $(SUPABASE_PROJECT_ID)
              SUPABASE_DB_PASSWORD: $(SUPABASE_DB_PASSWORD)
            workingDirectory: $(System.DefaultWorkingDirectory)

          - script: |
              echo "Applying database migrations..."
              export PATH="$(Agent.ToolsDirectory)/supabase:$PATH"
              supabase db push
            displayName: "Push Migrations to Supabase"
            continueOnError: false
            workingDirectory: $(System.DefaultWorkingDirectory)
            env:
              SUPABASE_DB_PASSWORD: $(SUPABASE_DB_PASSWORD)

  - stage: Push
    displayName: Push Docker Image to GHCR
    dependsOn: Migrate
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - job: Push
        displayName: Push image
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - task: Docker@2
            displayName: "Push to GHCR"
            inputs:
              command: "push"
              containerRegistry: "$(dockerRegistryServiceConnection)"
              repository: "$(imageRepository)"
              tags: |
                $(tagTest)
                $(tagBuildId)

  - stage: Deploy
    displayName: Deploy to DigitalOcean App Platform
    dependsOn: Push
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - job: Deploy
        displayName: Trigger DigitalOcean Deploy
        pool:
          name: Default
          demands:
            - Agent.OS -equals Linux
        steps:
          - script: |
              echo "Triggering deployment on DigitalOcean App Platform..."
              http_code=$(curl -sS -o /tmp/do_deploy.json -w "%{http_code}" \
                -X POST \
                -H "Authorization: Bearer $DO_API_TOKEN" \
                -H "Content-Type: application/json" \
                "https://api.digitalocean.com/v2/apps/$DO_APP_ID/deployments")
              echo "POST /deployments => $http_code"
              cat /tmp/do_deploy.json
              case "$http_code" in
                200|201|202) echo "Deployment triggered." ;;
                *) echo "Deployment API failed"; exit 1 ;;
              esac
            displayName: "Call DigitalOcean API to redeploy"
            env:
              DO_API_TOKEN: $(DO_API_TOKEN)
              DO_APP_ID: $(DO_APP_ID)
