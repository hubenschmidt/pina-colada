services:
  # log-daemon:
  #   image: docker:cli
  #   container_name: log-daemon
  #   restart: always
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - ./logs:/logs
  #   command: >
  #     sh -c '
  #     mkdir -p /logs &&
  #     rm -f /logs/*.log &&
  #     echo "Container logs started, saved to logs/ directory" &&
  #     docker logs -f pina-colada-client-1 2>&1 | while IFS= read -r line; do
  #       DATE=$$(date +%Y-%m-%d)
  #       echo "[client] $$line" >> /logs/client-$$DATE.log
  #       echo "[client] $$line" >> /logs/docker-compose-$$DATE.log
  #     done &
  #     docker logs -f pina-colada-agent-1 2>&1 | while IFS= read -r line; do
  #       DATE=$$(date +%Y-%m-%d)
  #       echo "[agent] $$line" >> /logs/agent-$$DATE.log
  #       echo "[agent] $$line" >> /logs/docker-compose-$$DATE.log
  #     done &
  #     docker logs -f pina-colada-postgres-1 2>&1 | while IFS= read -r line; do
  #       DATE=$$(date +%Y-%m-%d)
  #       echo "[langfuse-postgres] $$line" >> /logs/langfuse-postgres-$$DATE.log
  #       echo "[langfuse-postgres] $$line" >> /logs/docker-compose-$$DATE.log
  #     done &
  #     docker logs -f pina-colada-app-postgres-1 2>&1 | while IFS= read -r line; do
  #       DATE=$$(date +%Y-%m-%d)
  #       echo "[app-postgres] $$line" >> /logs/app-postgres-$$DATE.log
  #       echo "[app-postgres] $$line" >> /logs/docker-compose-$$DATE.log
  #     done &
  #     wait
  #     '
  #   depends_on:
  #     - client
  #     - agent
  #     - postgres
  #     - app-postgres

  client:
    build:
      context: ./modules/client
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3001"
    volumes:
      - ./modules/client:/app
      - /app/node_modules
    env_file:
      - ./modules/client/.env.local
    environment:
      # Override API URL to use Docker service name (for server-side proxy)
      NEXT_PUBLIC_API_URL: http://agent:8000
      # WebSocket URL for browser (must be accessible from host)
      NEXT_PUBLIC_WS_URL: ws://localhost:8000/ws
      # Postgres connection for local dev (when USE_LOCAL_POSTGRES=true)
      POSTGRES_HOST: app-postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${COMPOSE_PROJECT_NAME:-pina-colada}
    depends_on:
      app-postgres:
        condition: service_healthy
    command: ["npm", "run", "dev"] # overrides Dockerfile start command in dev env
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  agent:
    build:
      context: ./modules/agent
      dockerfile: Dockerfile.dev
      target: dev
    volumes:
      - ./modules/agent:/app
      - ./storage:/storage  # Shared storage volume
    env_file:
      - ./modules/agent/.env
    environment:
      - PORT=8000
      - ENV=development
      - DATABASE_URL=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@app-postgres:5432/${COMPOSE_PROJECT_NAME:-pina-colada}?sslmode=disable
      - STORAGE_PATH=/storage  # Use shared storage path
      # - LANGFUSE_HOST=http://langfuse:3000
    ports:
      - "8000:8000"
    depends_on:
      app-postgres:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # --- Langfuse web/UI ---
  # Make sure to update the credential placeholders with your own secrets.
  # We mark them with # CHANGEME in the file below.
  # In addition, we recommend to restrict inbound traffic on the host to langfuse-web (port 3000) and minio (port 9090) only.
  # All other components are bound to localhost (127.0.0.1) to only accept connections from the local machine.
  # External connections from other machines will not be able to reach these services directly.
  # langfuse-worker:
  #   image: docker.io/langfuse/langfuse-worker:3
  #   restart: always
  #   depends_on: &langfuse-depends-on
  #     postgres:
  #       condition: service_healthy
  #     minio:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     clickhouse:
  #       condition: service_healthy
  #   ports:
  #     - 127.0.0.1:3030:3030
  #   environment: &langfuse-worker-env
  #     NEXTAUTH_URL: ${NEXTAUTH_URL}
  #     DATABASE_URL: ${DATABASE_URL} # CHANGEME
  #     SALT: ${SALT} # CHANGEME
  #     ENCRYPTION_KEY: ${ENCRYPTION_KEY} # CHANGEME: generate via `openssl rand -hex 32`
  #     TELEMETRY_ENABLED: ${TELEMETRY_ENABLED:-true}
  #     LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: ${LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES:-true}
  #     CLICKHOUSE_MIGRATION_URL: ${CLICKHOUSE_MIGRATION_URL:-clickhouse://clickhouse:9000}
  #     CLICKHOUSE_URL: ${CLICKHOUSE_URL:-http://clickhouse:8123}
  #     CLICKHOUSE_USER: ${CLICKHOUSE_USER:-clickhouse}
  #     CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse} # CHANGEME
  #     CLICKHOUSE_CLUSTER_ENABLED: ${CLICKHOUSE_CLUSTER_ENABLED:-false}
  #     LANGFUSE_USE_AZURE_BLOB: ${LANGFUSE_USE_AZURE_BLOB:-false}
  #     LANGFUSE_S3_EVENT_UPLOAD_BUCKET: ${LANGFUSE_S3_EVENT_UPLOAD_BUCKET:-langfuse}
  #     LANGFUSE_S3_EVENT_UPLOAD_REGION: ${LANGFUSE_S3_EVENT_UPLOAD_REGION:-auto}
  #     LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: ${LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID:-minio}
  #     LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: ${LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY:-miniosecret} # CHANGEME
  #     LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: ${LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT:-http://minio:9000}
  #     LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: ${LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE:-true}
  #     LANGFUSE_S3_EVENT_UPLOAD_PREFIX: ${LANGFUSE_S3_EVENT_UPLOAD_PREFIX:-events/}
  #     LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: ${LANGFUSE_S3_MEDIA_UPLOAD_BUCKET:-langfuse}
  #     LANGFUSE_S3_MEDIA_UPLOAD_REGION: ${LANGFUSE_S3_MEDIA_UPLOAD_REGION:-auto}
  #     LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: ${LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID:-minio}
  #     LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: ${LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY:-miniosecret} # CHANGEME
  #     LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: ${LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT:-http://localhost:9090}
  #     LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: ${LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE:-true}
  #     LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: ${LANGFUSE_S3_MEDIA_UPLOAD_PREFIX:-media/}
  #     LANGFUSE_S3_BATCH_EXPORT_ENABLED: ${LANGFUSE_S3_BATCH_EXPORT_ENABLED:-false}
  #     LANGFUSE_S3_BATCH_EXPORT_BUCKET: ${LANGFUSE_S3_BATCH_EXPORT_BUCKET:-langfuse}
  #     LANGFUSE_S3_BATCH_EXPORT_PREFIX: ${LANGFUSE_S3_BATCH_EXPORT_PREFIX:-exports/}
  #     LANGFUSE_S3_BATCH_EXPORT_REGION: ${LANGFUSE_S3_BATCH_EXPORT_REGION:-auto}
  #     LANGFUSE_S3_BATCH_EXPORT_ENDPOINT: ${LANGFUSE_S3_BATCH_EXPORT_ENDPOINT:-http://minio:9000}
  #     LANGFUSE_S3_BATCH_EXPORT_EXTERNAL_ENDPOINT: ${LANGFUSE_S3_BATCH_EXPORT_EXTERNAL_ENDPOINT:-http://localhost:9090}
  #     LANGFUSE_S3_BATCH_EXPORT_ACCESS_KEY_ID: ${LANGFUSE_S3_BATCH_EXPORT_ACCESS_KEY_ID:-minio}
  #     LANGFUSE_S3_BATCH_EXPORT_SECRET_ACCESS_KEY: ${LANGFUSE_S3_BATCH_EXPORT_SECRET_ACCESS_KEY:-miniosecret} # CHANGEME
  #     LANGFUSE_S3_BATCH_EXPORT_FORCE_PATH_STYLE: ${LANGFUSE_S3_BATCH_EXPORT_FORCE_PATH_STYLE:-true}
  #     LANGFUSE_INGESTION_QUEUE_DELAY_MS: ${LANGFUSE_INGESTION_QUEUE_DELAY_MS:-}
  #     LANGFUSE_INGESTION_CLICKHOUSE_WRITE_INTERVAL_MS: ${LANGFUSE_INGESTION_CLICKHOUSE_WRITE_INTERVAL_MS:-}
  #     REDIS_HOST: ${REDIS_HOST:-redis}
  #     REDIS_PORT: ${REDIS_PORT:-6379}
  #     REDIS_AUTH: ${REDIS_AUTH:-myredissecret} # CHANGEME
  #     REDIS_TLS_ENABLED: ${REDIS_TLS_ENABLED:-false}
  #     REDIS_TLS_CA: ${REDIS_TLS_CA:-/certs/ca.crt}
  #     REDIS_TLS_CERT: ${REDIS_TLS_CERT:-/certs/redis.crt}
  #     REDIS_TLS_KEY: ${REDIS_TLS_KEY:-/certs/redis.key}
  #     EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS:-}
  #     SMTP_CONNECTION_URL: ${SMTP_CONNECTION_URL:-}

  # langfuse:
  #   image: langfuse/langfuse:latest
  #   restart: always
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   ports:
  #     - 3000:3000
  #   environment:
  #     <<: *langfuse-worker-env
  #     NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
  #     LANGFUSE_INIT_ORG_ID: ${LANGFUSE_INIT_ORG_ID:-}
  #     LANGFUSE_INIT_ORG_NAME: ${LANGFUSE_INIT_ORG_NAME:-}
  #     LANGFUSE_INIT_PROJECT_ID: ${LANGFUSE_INIT_PROJECT_ID:-}
  #     LANGFUSE_INIT_PROJECT_NAME: ${LANGFUSE_INIT_PROJECT_NAME:-}
  #     LANGFUSE_INIT_PROJECT_PUBLIC_KEY: ${LANGFUSE_INIT_PROJECT_PUBLIC_KEY:-}
  #     LANGFUSE_INIT_PROJECT_SECRET_KEY: ${LANGFUSE_INIT_PROJECT_SECRET_KEY:-}
  #     LANGFUSE_INIT_USER_EMAIL: ${LANGFUSE_INIT_USER_EMAIL:-}
  #     LANGFUSE_INIT_USER_NAME: ${LANGFUSE_INIT_USER_NAME:-}
  #     LANGFUSE_INIT_USER_PASSWORD: ${LANGFUSE_INIT_USER_PASSWORD:-}

  # clickhouse:
  #   image: docker.io/clickhouse/clickhouse-server
  #   restart: always
  #   user: "101:101"
  #   environment:
  #     CLICKHOUSE_DB: ${CLICKHOUSE_DB}
  #     CLICKHOUSE_USER: ${CLICKHOUSE_USER}
  #     CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
  #   volumes:
  #     - langfuse_clickhouse_data:/var/lib/clickhouse
  #     - langfuse_clickhouse_logs:/var/log/clickhouse-server
  #   ports:
  #     - 127.0.0.1:8123:8123
  #     - 127.0.0.1:9000:9000
  #   healthcheck:
  #     test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
  #     interval: 5s
  #     timeout: 5s
  #     retries: 10
  #     start_period: 1s

  # minio:
  #   image: docker.io/minio/minio
  #   restart: always
  #   entrypoint: sh
  #   # create the 'langfuse' bucket before starting the service
  #   command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
  #   environment:
  #     MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
  #     MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-miniosecret} # CHANGEME
  #   ports:
  #     - 9090:9000
  #     - 127.0.0.1:9091:9001
  #   volumes:
  #     - langfuse_minio_data:/data
  #   healthcheck:
  #     test: ["CMD", "mc", "ready", "local"]
  #     interval: 1s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 1s

  # redis:
  #   image: docker.io/redis:7
  #   restart: always
  #   # CHANGEME: row below to secure redis password
  #   command: >
  #     --requirepass ${REDIS_AUTH:-myredissecret}
  #   ports:
  #     - 127.0.0.1:6379:6379
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 3s
  #     timeout: 10s
  #     retries: 10

  # postgres:
  #   image: docker.io/postgres:${POSTGRES_VERSION:-17}
  #   restart: always
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 3s
  #     timeout: 3s
  #     retries: 10
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER:-postgres}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres} # CHANGEME
  #     POSTGRES_DB: langfuse
  #     TZ: UTC
  #     PGTZ: UTC
  #   ports:
  #     - 127.0.0.1:5433:5432
  #   volumes:
  #     - langfuse_postgres_data:/var/lib/postgresql/data
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   # Langfuse-only Postgres instance

  app-postgres:
    image: docker.io/postgres:${POSTGRES_VERSION:-17}
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 3s
      timeout: 3s
      retries: 10
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres} # CHANGEME
      POSTGRES_DB: ${COMPOSE_PROJECT_NAME:-pina-colada}
      TZ: UTC
      PGTZ: UTC
    ports:
      - 127.0.0.1:5432:5432
    volumes:
      - app_postgres_data:/var/lib/postgresql/data
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # App-only Postgres instance (pina-colada database)

volumes:
  app_postgres_data:
    name: ${COMPOSE_PROJECT_NAME}_app_postgres_data
    driver: local
  # langfuse_postgres_data:
  #   name: ${COMPOSE_PROJECT_NAME}_langfuse_postgres_data
  #   driver: local
  # langfuse_clickhouse_data:
  #   name: ${COMPOSE_PROJECT_NAME}_langfuse_clickhouse_data
  #   driver: local
  # langfuse_clickhouse_logs:
  #   name: ${COMPOSE_PROJECT_NAME}_langfuse_clickhouse_logs
  #   driver: local
  # langfuse_minio_data:
  #   name: ${COMPOSE_PROJECT_NAME}_langfuse_minio_data
  #   driver: local
